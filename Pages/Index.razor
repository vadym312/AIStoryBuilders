@page "/"
@using AIStoryBuilders.Model;
@using AIStoryBuilders.Models;
@using AIStoryBuilders.Models.JSON;
@using AIStoryBuilders.Pages.Controls;
@using AIStoryBuilders.Pages.Controls.Story;
@using AIStoryBuilders.Services;
@using Newtonsoft.Json;
@using static AIStoryBuilders.Services.AIStoryBuildersService;
@using static AIStoryBuilders.Model.OrchestratorMethods;
@inherits OwningComponentBase
@inject DialogService dialogService
@inject NotificationService NotificationService
@inject SettingsService SettingsService
@implements IDisposable
<PageTitle>AI Story Builders</PageTitle>
<RadzenMenu>
    <RadzenMenuItem Click="OnHomeClicked" Text="Home" Icon="home"></RadzenMenuItem>
    <RadzenMenuItem Click="OnMemoryClicked" Text="Memory" Icon="aspect_ratio"></RadzenMenuItem>
    <RadzenMenuItem Click="OnLogsClicked" Text="Logs" Icon="assignment"></RadzenMenuItem>
    <RadzenMenuItem Click="OnSettingsClicked" Text="Settings" Icon="line_style"></RadzenMenuItem>
</RadzenMenu>
<br />
<RadzenButton Click=@(() => Test()) Text="Test" ButtonStyle="ButtonStyle.Danger" />
@if (@InProgress)
{
    <div class="rz-m-10">
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    </div>
}
@if (HomeVisible)
{
    <RadzenButton Click=@(() => NewStory()) Text="New Story" ButtonStyle="ButtonStyle.Success" />
    <br />
    <br />
    <div style="height:500px">
        <RadzenDataList AllowVirtualization=false Style="height:100%;overflow:auto;"
                        WrapItems=true AllowPaging=false
                        Data="@colStorys" TItem="Story">
            <Template Context="story">
                <RadzenCard Style="width: 100%; padding: 1;">
                    <RadzenRow Gap="0">
                        <RadzenButton Text="Select" Click=@(() => EditStory(story))
                                      ButtonStyle="ButtonStyle.Light" Style="width: 150px;height: 20px" />
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <RadzenText TextStyle="TextStyle.DisplayH5"
                                    class="rz-color-secondary">@(story.Title)</RadzenText>&nbsp;&nbsp;
                        </RadzenRow>
                    </RadzenCard>
                </Template>
            </RadzenDataList>
        </div>
}
@if (SettingsVisible)
{
    <Settings></Settings>
}
@if (MemoryVisible)
{
    <Memory></Memory>
}
@if (LogsVisible)
{
    <Logs></Logs>
}
@code {
    AIStoryBuildersService AIStoryBuildersService;
    OrchestratorMethods OrchestratorMethods;
    LogService LogService;

    List<Story> colStorys = new List<Story>();
    Story objStory = new Story();

    string Organization = "";
    string ApiKey = "";

    bool InProgress = false;
    bool HomeVisible = true;
    bool SettingsVisible = false;
    bool MemoryVisible = false;
    bool LogsVisible = false;

    private void Test()
    {
        try
        {
            // Single
            //string RawJSON = @"{ ""locations"": [ { ""name"": ""Mother’s home"", ""descriptions"": [""A home in the forest where the three pigs lived before setting out to build their own houses.""] }, { ""name"": ""Straw house"", ""descriptions"": [""The first house built by Tom, the first pig, made entirely out of straw.""] }, { ""name"": ""Stick house"", ""descriptions"": [""The second house built by Joe, the second pig, made entirely out of sticks.""] }, { ""name"": ""Brick house"", ""descriptions"": [""The third house built by Charlie, the third pig, made entirely out of bricks.""] } ], ""timelines"": [ { ""name"": ""Pigs' Journey"", ""description"": ""The three pigs, Tom, Joe, and Charlie, leave their mother's home in the forest in early summer to build their own houses."" }, { ""name"": ""Wolf's Attack"", ""description"": ""A wolf tries to eat the pigs but fails to blow down the brick house and falls into a cauldron, dying."" } ], ""characters"": [ { ""name"": ""Tom"", ""descriptions"": { ""description_type"": ""History"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""Tom is the first pig who builds his house out of straw."", ""timeline_name"": ""Pigs' Journey"" } }, { ""name"": ""Joe"", ""descriptions"": { ""description_type"": ""History"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""Joe is the second pig who builds his house out of sticks."", ""timeline_name"": ""Pigs' Journey"" } }, { ""name"": ""Charlie"", ""descriptions"": { ""description_type"": ""History"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""Charlie is the third pig who builds his house out of bricks."", ""timeline_name"": ""Pigs' Journey"" } }, { ""name"": ""Wolf"", ""descriptions"": { ""description_type"": ""History"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""The wolf tries to eat the pigs but fails and dies."", ""timeline_name"": ""Wolf's Attack"" } } ] }";

            // Multiple
            string RawJSON = @"{ ""locations"": [ { ""name"": ""Main Street"", ""descriptions"": [""John lives in a box on Main Street before becoming rich.""] } ], ""timelines"": [ { ""name"": ""John's Transformation"", ""description"": ""John goes from living in a box on Main Street to becoming a rich man with the help of Mary."" }, { ""name"": ""Mary's Kindness"", ""description"": ""Mary helps John by giving him a dollar, which leads to his success. Later, John returns the favor."" } ], ""characters"": [ { ""name"": ""John"", ""descriptions"": [ { ""description_type"": ""Appearance"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""John has red hair."", ""timeline_name"": ""John's Transformation"" }, { ""description_type"": ""Goals"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""John wants to find a home to live in."", ""timeline_name"": ""John's Transformation"" }, { ""description_type"": ""History"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""John was once poor and lived in a box, but later became rich."", ""timeline_name"": ""John's Transformation"" } ] }, { ""name"": ""Mary"", ""descriptions"": [ { ""description_type"": ""Appearance"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""Mary has green hair."", ""timeline_name"": ""Mary's Kindness"" }, { ""description_type"": ""History"", ""enum"": [""Appearance"",""Goals"",""History"",""Aliases"",""Facts""], ""description"": ""Mary helped John by giving him a dollar, which led to his success. Later, John returned the favor."", ""timeline_name"": ""Mary's Kindness"" } ] } ] }";

            JSONNewStory ParsedNewStory = AIStoryBuildersService.ParseJSONNewStory(RawJSON);
        }
        catch (Exception ex)
        {
            HomeVisible = true;
            InProgress = false;

            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = ex.Message,
                    Duration = 4000
                });

            LogService.WriteToLog(ex.Message);
        }
    }

    protected override void OnInitialized()
    {
        try
        {
            AIStoryBuildersService = (AIStoryBuildersService)ScopedServices.GetService(typeof(AIStoryBuildersService));
            OrchestratorMethods = (OrchestratorMethods)ScopedServices.GetService(typeof(OrchestratorMethods));
            LogService = (LogService)ScopedServices.GetService(typeof(LogService));

            AIStoryBuildersService.TextEvent += AIStoryBuildersService_TextEvent;
            OrchestratorMethods.ReadTextEvent += OrchestratorMethods_ReadTextEvent;

            SettingsService.LoadSettings();
            Organization = SettingsService.Organization;
            ApiKey = SettingsService.ApiKey;

            if (ApiKey == "")
            {
                // Switch to the Settings page
                HomeVisible = false;
                SettingsVisible = true;
                MemoryVisible = false;
                LogsVisible = false;
            }
            else
            {
                // Get the Storys from the database
                colStorys = AIStoryBuildersService.GetStorys();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = ex.Message,
                    Duration = 4000
                });

            LogService.WriteToLog(ex.Message);
        }
    }

    private async Task NewStory()
    {
        try
        {        
            var NewStoryResult = await dialogService.OpenAsync<NewStory>($"New Story",
                null,
                new DialogOptions() { Width = "650px" });

            if (NewStoryResult != null)
            {
                objStory = (Story)NewStoryResult;

                if (objStory != null)
                {         
                    HomeVisible = false;
                    InProgress = true;
                    StateHasChanged();

                    // Save Story to the database
                    await AIStoryBuildersService.AddStory(objStory);

                    HomeVisible = true;
                    InProgress = false;
                    StateHasChanged();

                    var parms = new Dictionary<string, object>();
                    parms.Add("objStory", objStory);

                    var EditStoryResult = await dialogService.OpenAsync<EditStory>($"{objStory.Title}", parms,
                    new DialogOptions() { Height = "650px", Width = "800px" });
                }

                colStorys = AIStoryBuildersService.GetStorys();

                StateHasChanged();

                HomeVisible = true;
                InProgress = false;
            }
        }
        catch (Exception ex)
        {
            HomeVisible = true;
            InProgress = false;

            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = ex.Message,
                    Duration = 4000
                });

            LogService.WriteToLog(ex.Message);
        }
    }

    private async Task EditStory(Story paramStory)
    {
        try
        {
            if (paramStory.Id == -1)
            {
                // It is a New Story and needs processing
                // Show the Progress bar
                InProgress = true; 
            }

            var parms = new Dictionary<string, object>();
            parms.Add("objStory", paramStory);

            var EditStoryResult = await dialogService.OpenAsync<EditStory>($"{paramStory.Title}", parms,
            new DialogOptions() { Height = "700px", Width = "800px" });

            colStorys = AIStoryBuildersService.GetStorys();

            StateHasChanged();

            InProgress = false;
        }
        catch (Exception ex)
        {
            InProgress = false;

            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = ex.Message,
                    Duration = 4000
                });

            LogService.WriteToLog(ex.Message);
        }
    }

    void OnHomeClicked(MenuItemEventArgs args)
    {
        HomeVisible = true;
        SettingsVisible = false;
        MemoryVisible = false;
        LogsVisible = false;
    }

    void OnSettingsClicked(MenuItemEventArgs args)
    {
        HomeVisible = false;
        SettingsVisible = true;
        MemoryVisible = false;
        LogsVisible = false;
    }

    void OnMemoryClicked(MenuItemEventArgs args)
    {
        HomeVisible = false;
        SettingsVisible = false;
        MemoryVisible = true;
        LogsVisible = false;
    }

    void OnLogsClicked(MenuItemEventArgs args)
    {
        HomeVisible = false;
        SettingsVisible = false;
        MemoryVisible = false;
        LogsVisible = true;
    }

    // Events

    private void OrchestratorMethods_ReadTextEvent(object sender, EventArgs e)
    {
        ReadTextEventArgs ReadTextEventArguments = (ReadTextEventArgs)e;

        NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Info,
                Summary = "Info",
                Detail = ReadTextEventArguments.Message,
                Duration = 4000
            });
    }

    private void AIStoryBuildersService_TextEvent(object sender, EventArgs e)
    {
        TextEventArgs ReadTextEventArguments = (TextEventArgs)e;

        NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Info,
                Summary = "Info",
                Detail = ReadTextEventArguments.Message,
                Duration = 4000
            });
    }

    public void Dispose()
    {
        OrchestratorMethods.ReadTextEvent -= OrchestratorMethods_ReadTextEvent;
        AIStoryBuildersService.TextEvent -= AIStoryBuildersService_TextEvent;
    }
}